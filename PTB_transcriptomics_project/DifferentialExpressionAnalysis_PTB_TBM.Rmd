---
title: "DifferentialExpressionAnalysis_PTB_TBM"
author: "Triet"
date: "2024-01-18"
output: html_document
---

# Hey! I am trying to organize all the work

## 1. Import libraries and data

```{r setup, include=FALSE}
#knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE)
library(parallel)
mcore<-1 # for Window PC

#Load libraries
library(dplyr)
library(plyr)
library(readxl)
library(writexl)
library(survival)
library(glmnet)
library(stabs)
library(tidyverse)
library(magrittr)
library(Hmisc)
library(gtsummary)
library(WGCNA)
library(ggcorrplot)
library(scales)
library(gridExtra)
library(ggcorrplot)
library(broom)
library(rms)
library(tidyverse)
library("stabs")
library("mboost")
library(DESeq2)
library(CEMiTool)
```

```{r}
path_output<-paste0(str_replace_all(Sys.getenv("USERPROFILE"), '\\\\', '/'),
                     "/OneDrive - Oxford University Clinical Research Unit/#OUCRU-TB/#oucru-tb/PTB_project/Triet_Results")
path_input <- paste0(str_replace_all(Sys.getenv("USERPROFILE"), '\\\\', '/'),
                     "/OneDrive - Oxford University Clinical Research Unit/#OUCRU-TB/#oucru-tb/PTB_project/")
load(paste0(path_input,"/Raw_data/vst_Gensymbol_allPTB_295Sample_18Feb22.RData")) #vst_data 295 31425
load(paste0(path_input,"/Raw_data/vst_Gensymbol_allTBM_281Sample_12Jan24.RData")) #tbm_vst 281 31381
rownames(tbm_vst) <- tbm_vst$LIMS_ID
load(paste0(path_input,"/Data/Fluidigm_PTB_data.Rdata"))
load(paste0(path_input,"/Data/Most_variance_RNA_genes.Rdata"))
load(file=paste0(path_input,"Raw_data/count_data_adjusted_ComBat.Rdata"))
load(paste0(path_input, "Raw_data/Data_RNAseq_RUN1andRUN2_15Feb2023.RData"))
All_sample_RNAseq <- readxl::read_excel(paste0(path_input,"Raw_data/All_sample_RNAseq.xlsx"),sheet = "Run1and2") %>% as.data.frame()
rownames(All_sample_RNAseq) <- All_sample_RNAseq$LIMS_ID
```

```{r}

vst_ptb_tbm <- rbind.fill(vst_data,tbm_vst)
vst_ptb_tbm %<>% mutate(Type=ifelse(LIMS_ID %in% vst_data$LIMS_ID,"PTB","TBM"))
#rownames(vst_ptb_tbm) <- vst_ptb_tbm$LIMS_ID

healthy_ComBat <- count_data_adjusted_ComBat %>% filter(LIMS_ID %in% filter(Cli_All,trial_number %in% c('HV','43TB'))$LIMS_ID)
qt<-quantile(healthy_ComBat$CNIH4,c(0.75)) #Q3 CNIH4 of healthy control

PTB_TBM_ComBat <- count_data_adjusted_ComBat %>% filter(LIMS_ID %in% filter(Cli_All,(Timepoint=='D0') & (trial_number %in% c('MDR_PTB','DS_PTB','26TB','27TB')))$LIMS_ID)
PTB_TBM_ComBat %<>% mutate(CNIH4level=ifelse((CNIH4<qt[1]),1,2))
#rownames(PTB_TBM_ComBat) <- PTB_TBM_ComBat$LIMS_ID
vst_ptb_tbm <- merge(vst_ptb_tbm,PTB_TBM_ComBat %>% select('LIMS_ID','CNIH4level'),by="LIMS_ID")
rownames(vst_ptb_tbm) <- vst_ptb_tbm$LIMS_ID
```

## 2. Helper functions

```{r}
cor.pval.test <- function(x1, x2, ...) {
  r <- ncol(x1)
  n <- ncol(x2)
  p.mat<- matrix(NA, r, n)
  for (i in 1:r) {
    for (j in 1:n) {
      tmp <- cor.test(x1[, i], x2[, j], ...)
      p.mat[i, j] <- tmp$p.value
    }
  }
  rownames(p.mat) <-  colnames(x1)
  colnames(p.mat) <- colnames(x2)
  return(p.mat)
}

anno_gene_symbol <- function(data,data_anno,export, name=NULL){
  anno_DESeq2 <- data_anno[,c("gene_id", "gene_symbol")]
  anno_DESeq2 <- subset(anno_DESeq2, gene_id %in% data$gene_id)
  data
  return(data)
}

get_genelist_pathway_kegg <- function(hsa_ID){
  library("KEGGREST")
  names <- keggGet(hsa_ID)[[1]]$GENE
  namesodd <-  names[seq(0,length(names),2)]
  namestrue <- gsub("\\;.*","",namesodd)
}
```

## \*Draft analysis - Playground (just for the experimental stuffs)

```{r}
library(ggplot2)
library(ggpmisc)
df <- filter(vst_ptb_tbm,Type=='PTB') %>% select(c('CNIH4','CD274','CD58','CT_mean')) %>% mutate(CD274_CD58=CD274/CD58)

ggcorrplot(cor(df, use='pairwise.complete.obs',method = cor_method),
           p.mat = cor.pval.test(df, df, method=cor_method, use='pairwise.complete.obs'), 
           lab = T,
           lab_size = 2,
           insig="blank",
           outline.color = 'black')+
  theme(legend.position="right")+
  labs(fill="Corr")+
  theme(axis.text.x = element_text(face="bold", colour="black", size=12),
        axis.text.y = element_text(face="bold", colour="black", size=12),
        legend.text = element_text(size = 15),
        legend.title = element_text( colour="black", size=12))+
  guides(fill = guide_colourbar(title = "Corr",
                                size=15,
                                barheight = 40))

ggplot(data=df, aes_string(x='CNIH4',y=as.name('CD274_CD58')))+
  geom_point(alpha=0.2,col='red')+
  theme_bw()+
  stat_poly_line(se=T) +
  stat_cor(cor.coef.name = "r",size = 7,method = 'spearman')+
  theme_bw()+ 
  ylab(paste0(as.name('CD58')," expression"))+
  xlab("CNIH4 expression")+
  theme(plot.title = element_text(size = 15),
        legend.position = "none",
        axis.text = element_text(size = 15),
        axis.text.x=element_text(color="black",size=13,face="bold"),
        axis.title.x = element_text(size = 15,color="black",face="bold"),
        axis.text.y=element_text(color="black",size=15),
        axis.title.y = element_text(size = 15,color="black",face="bold"),
        legend.text = element_text(size = 15),
        legend.title = element_text( colour="black", size=12),
        legend.key = element_rect(colour = NA),
        strip.text=element_text(face = "bold",size=12))
  #scale_fill_gradientn(colors=natparks.pals("Acadia"),limit = c(-1,1))
```

```{r}
library(gtsummary)
df <- filter(vst_ptb_tbm,Type=='PTB') %>% mutate(Cavity = ifelse(Cavity_CXR=='N',0,1))
df %<>% mutate(Neutrophil_counts=WBC*NEUTLE*0.01,
                     log2_Neutrophil_counts=log2(Neutrophil_counts),
                     Lymphocyte_counts=WBC*LYMLE *0.01,
                     log2_Lymphocyte_counts=log2(Lymphocyte_counts),
                     Monocyte_counts=WBC*MONOLE*0.01,
                     log2_Monocyte_counts=log2(Monocyte_counts),
                     Eosinophil_counts=WBC*EOSLE*0.01,
                     log2_Eosinophil_counts=log2(Eosinophil_counts))

model1 <- lm(CNIH4~CT_mean, data = df)
summary(model1)
tbl_regression(model1,intercept = TRUE,estimate_fun = purrr::partial(style_ratio, digits = 3)) %>%
  bold_labels() %>%
  modify_column_unhide(columns = c(statistic, std.error)) %>% as_flex_table() %>%
  flextable::save_as_docx(path=paste0(path_output,"/lm_CNIH4vsCT_mean.docx"))

model2 <- lm(CNIH4~CT_mean+Neutrophil_counts+Lymphocyte_counts+Monocyte_counts + Eosinophil_counts +CD274,data=df)
summary(model2)
tbl_regression(model2,intercept = TRUE,estimate_fun = purrr::partial(style_ratio, digits = 3)) %>%
  bold_labels() %>%
  modify_column_unhide(columns = c(statistic, std.error)) %>% as_flex_table() %>%
  flextable::save_as_docx(path=paste0(path_output,"/lm_CNIH4vsAll.docx"))

model3 <- glm(Cavity~CNIH4+CD274+CD58+CT_mean,family=binomial(link='logit'),data=df)
summary(model3)
tbl_regression(model3,intercept = TRUE,estimate_fun = purrr::partial(style_ratio, digits = 3)) %>%
  bold_labels() %>%
  modify_column_unhide(columns = c(statistic, std.error))  %>% as_flex_table() %>%
  flextable::save_as_docx(path=paste0(path_output,"/glm_CavityvsCNIH4_CD274_CD58_CT_mean.docx"))
```

## 3. Main Analysis

### Hurdles Model

```{r}
library(brms)
library(cmdstanr)
library(posterior)
library(bayesplot)
library(tidybayes)
library(broom)
library(dplyr)
library(ggplot2)
library(broom.mixed)

options(mc.cores = 1, brms.backend = "cmdstanr")

CHAINS <- 4
ITER <- 2000
WARMUP <- 1000
BAYES_SEED <- 1234

# Create a custom family that is logit if y = 0, normal/gaussian if not
hurdle_gaussian <- custom_family("hurdle_gaussian", 
                dpars = c("mu", "sigma", "hu"),
                links = c("identity", "log", "logit"),
                lb = c(NA, 0, NA),
                type = "real")

# Stan code
stan_funs <- "
  real hurdle_gaussian_lpdf(real y, real mu, real sigma, real hu) { 
    if (y == 0) { 
      return bernoulli_lpmf(1 | hu); 
    } else { 
      return bernoulli_lpmf(0 | hu) +  
             normal_lpdf(y | mu, sigma); 
    } 
  }
"
# Prepare Stan code for use in brm()
stanvars <- stanvar(scode = stan_funs, block = "functions")
set_cmdstan_path('C:/Users/triettm/AppData/Local/R/win-library/4.3/.cmdstan/cmdstan-2.33.1')
```

```{r}
Fludigm_CNIH4_PTB <- get(load(paste0(path_input,'Raw_data/Fludigm_CNIH4_PTB.Rdata')))
dim(Fludigm_CNIH4_PTB)# 171  12
hist(Fludigm_CNIH4_PTB$CT_Xpert_mean)

Fludigm_CNIH4_PTB %<>% mutate(
  bacterial_load_1 = log2(40/CT_Xpert_mean)
)

ggplot( Fludigm_CNIH4_PTB,aes(x = bacterial_load_1, y = CT_Xpert_mean))+
  geom_point()

hist(Fludigm_CNIH4_PTB$bacterial_load_1)

Hmisc::describe(Fludigm_CNIH4_PTB)


hist(Fludigm_CNIH4_PTB$log2_CT)
colnames(Fludigm_CNIH4_PTB)


model_hurdle_CNIH4 <- brm(
  bf(bacterial_load_1 ~ CNIH4_Norm,
     hu ~ CNIH4_Norm),
  data = Fludigm_CNIH4_PTB,
  family = hurdle_gaussian,  # <--- This is new
  stanvars = stanvars,   # <--- This is new
  chains = CHAINS, iter = ITER, warmup = WARMUP, seed = BAYES_SEED,
  silent = 2
)

tidy(model_hurdle_CNIH4)
# non-hurdle: 0.103 [0.0249,0.183], p = 0.0090
# hurdle: -0.130, [-1.23, 0.955], p = 0.8085
p_value(model_hurdle_CNIH4) # 

pp_check(model_hurdle_CNIH4, ndraws = 500)

c_CNIH4 <- cbind.data.frame(
  data.frame(tidy(model_hurdle_CNIH4))[1:4,4:8],
  p.value=p_value(model_hurdle_CNIH4)[,2])

colnames(c_CNIH4)<-c("Parameter","Estimate","std.error","conf.low","conf.high","p_value")

summary(Fludigm_CNIH4_PTB$CNIH4_Norm)

newdata=data.frame(CNIH4_Norm=seq(2,6.5,len=50))

pred_CNIH4<-fitted(model_hurdle_CNIH4, newdata = newdata)

d_pred_CNIH4<-cbind(newdata,pred_CNIH4)


d_pred_CNIH4<-d_pred_CNIH4 %>% mutate(CT_pred=40/2^(Estimate),
              lower_pred=40/2^(Q2.5),
              upper_pred=40/2^(Q97.5))
dim(d_pred_CNIH4)# 50  8
summary(d_pred_CNIH4$CNIH4_Norm)
summary(d_pred_CNIH4$CT_pred)

p_CNIH4<-ggplot(data=d_pred_CNIH4,aes(x=CNIH4_Norm,y=CT_pred))+
  geom_line(size=2,col="#313695")+
  geom_ribbon(aes(ymin=lower_pred,ymax=upper_pred,x=CNIH4_Norm),alpha=0.4,fill="#313695")+
  scale_y_continuous(trans = log2_trans(),
    breaks = (seq(10,40,by=5)),
    labels = seq(10,40,by=5))+
  
  geom_jitter(data=Fludigm_CNIH4_PTB,aes(x = CNIH4_Norm, y = CT_Xpert_mean  ), size=2.5,alpha=0.5)+
  theme_bw()+
  #labs(x = paste("CNIH4 Norm"," expression level [log2 counts] "), y = "Ct value")+
  labs(x = paste("CNIH4 Norm"), y = "Ct value")+
  theme(panel.grid.minor = element_blank(),axis.title.x = element_text(face="bold", colour="black", size=20),
        axis.title.y = element_text(face="bold", colour="black", size=20),
        axis.text.y = element_text( colour="black", size=15),
        axis.text.x = element_text( colour="black", size=15),
        axis.ticks.x=element_blank(),
        legend.text = element_text(size = 15),
        legend.title = element_text( colour="black", size=15),
        legend.key = element_rect(colour = NA),
        strip.text=element_text(face = "bold",size=15))+coord_cartesian(ylim=c(10,40))
p_CNIH4
```

### Regression Analysis

-   Regression CNIH4 \~ CT_mean

-   Regression CNIH4 \~ CT_mean + Neutrophil_counts + Lymphocyte_counts + Monocyte_counts + Eosinophil_counts +CD274

```{r}
library(gtsummary)
df <- filter(vst_ptb_tbm,Type=='PTB')
df %<>% mutate(Neutrophil_counts=WBC*NEUTLE*0.01,
                     log2_Neutrophil_counts=log2(Neutrophil_counts),
                     Lymphocyte_counts=WBC*LYMLE *0.01,
                     log2_Lymphocyte_counts=log2(Lymphocyte_counts),
                     Monocyte_counts=WBC*MONOLE*0.01,
                     log2_Monocyte_counts=log2(Monocyte_counts),
                     Eosinophil_counts=WBC*EOSLE*0.01,
                     log2_Eosinophil_counts=log2(Eosinophil_counts))

model1 <- lm(CNIH4~CT_mean, data = df)
tbl_regression(model1,intercept = TRUE,estimate_fun = purrr::partial(style_ratio, digits = 3)) %>%
  bold_labels() %>%
  modify_column_unhide(columns = c(statistic, std.error)) %>% as_flex_table() %>%
  flextable::save_as_docx(path=paste0(path_output,"/lm_CNIH4vsCT_mean.docx"))

model2 <- lm(CNIH4~CT_mean+Neutrophil_counts+Lymphocyte_counts+Monocyte_counts + Eosinophil_counts +CD274,data=df)
tbl_regression(model2,intercept = TRUE,estimate_fun = purrr::partial(style_ratio, digits = 3)) %>%
  bold_labels() %>%
  modify_column_unhide(columns = c(statistic, std.error)) %>% as_flex_table() %>%
  flextable::save_as_docx(path=paste0(path_output,"/lm_CNIH4vsAll.docx"))
```

### Differential Co-expression

```{r}
library(dcanr)

DiffCoexAnalysis <- function(data,gene_list,disease_type){
  df <- data %>% select(any_of(c(gene_list,'Type','CNIH4level'))) %>%filter(Type==disease_type)
  #df %<>% mutate(CNIH4level=ifelse(CNIH4level =='LOW',1, 2))
  cor_method = 'spearman'
  
  lowCNIH4_mat <- cor(df%>%filter(CNIH4level==1)%>%select(any_of(gene_list)),
                        use='pairwise.complete.obs',
                        method = cor_method)
  
  p.lowCNIH4_mat <- cor.pval.test(df%>%filter(CNIH4level==1)%>%select(any_of(TCR_gene_list)), 
                                  df%>%filter(CNIH4level==1)%>%select(any_of(TCR_gene_list)),
                                    method=cor_method,
                                    use='pairwise.complete.obs')
  
  highCNIH4_mat <- cor(df%>%filter(CNIH4level==2)%>%select(any_of(TCR_gene_list)),
                        use='pairwise.complete.obs',
                        method = cor_method)
  
  p.highCNIH4_mat <- cor.pval.test(df%>%filter(CNIH4level==2)%>%select(any_of(TCR_gene_list)), 
                                    df%>%filter(CNIH4level==2)%>%select(any_of(TCR_gene_list)), 
                                    method=cor_method, 
                                    use='pairwise.complete.obs')
  
  
  return(df)
}

gene_list <-c('TNFSF12','TSLP','TNFSF10','OSM','CSF1','LTA','IL33','IL27','IL18','IL17F','IL17A','IL15','IL13','CXCL8','IL7','IL6','IL4','IL2','CSF2','CSF3','FLT3LG','IL12A', 'IL12B', 'IL10', 'IL1B','IL6','IL4','IFNG','TNF')
df<-DiffCoexAnalysis(data=vst_ptb_tbm,gene_list = gene_list,disease_type='PTB')
View(df)
```

```{r}
library(dcanr)

#TCR_gene_list <-get_genelist_pathway_kegg('hsa04660')

TCR_gene_list <-c('TNFSF12','TSLP','TNFSF10','OSM','CSF1','LTA','IL33','IL27','IL18','IL17F','IL17A','IL15','IL13','CXCL8','IL7','IL6','IL4','IL2','CSF2','CSF3','FLT3LG','IL12A', 'IL12B', 'IL10', 'IL1B','IL6','IL4','IFNG','TNF') 

TCR_df <- vst_ptb_tbm %>% select(any_of(c(TCR_gene_list,'Type','CNIH4level'))) # Columns `PAK5`, `BUB1B-PAK6`, `IL2`, and `CSF2` don't exist.
colSums(is.na(TCR_df)) #Check NA
dim(TCR_df)
df <- filter(TCR_df,Type=='PTB')
#df <- df[order(df$CNIH4level,decreasing=FALSE, na.last=FALSE),]
df %<>% mutate(CNIH4level=ifelse(CNIH4level =='LOW',1, 2))

cor_method = 'spearman'
lowCNIH4_mat <- cor(df%>%filter(CNIH4level==1)%>%select(any_of(TCR_gene_list)),
                      use='pairwise.complete.obs',
                      method = cor_method)

p.lowCNIH4_mat <- cor.pval.test(df%>%filter(CNIH4level==1)%>%select(any_of(TCR_gene_list)), 
                                df%>%filter(CNIH4level==1)%>%select(any_of(TCR_gene_list)),
                                  method=cor_method, 
                                  use='pairwise.complete.obs')

highCNIH4_mat <- cor(df%>%filter(CNIH4level==2)%>%select(any_of(TCR_gene_list)),
                      use='pairwise.complete.obs',
                      method = cor_method)

p.highCNIH4_mat <- cor.pval.test(df%>%filter(CNIH4level==2)%>%select(any_of(TCR_gene_list)), 
                                  df%>%filter(CNIH4level==2)%>%select(any_of(TCR_gene_list)), 
                                  method=cor_method, 
                                  use='pairwise.complete.obs')

emat <- t(df%>%select(any_of(TCR_gene_list))) #tranpose
condition <- df$CNIH4level # high and low
scores <- dcScore(emat, 
                  condition,
                  dc.method = "zscore",
                  cor.method = 'spearman')
raw_p <- dcTest(scores, emat, condition)
raw_p[is.na(raw_p)] <- 1000
adj_p <- dcAdjust(raw_p, f = p.adjust, method = 'fdr')
```

```{r}
library(igraph)
library(qgraph)

col = c("#00b8ff","black","magenta")

highlow_mat <- highCNIH4_mat
highlow_mat[upper.tri(highCNIH4_mat,diag=F)] <- lowCNIH4_mat[upper.tri(lowCNIH4_mat,diag=F)]
p.highlow_mat <- p.highCNIH4_mat
p.highlow_mat[upper.tri(p.highCNIH4_mat,diag=F)] <- p.lowCNIH4_mat[upper.tri(p.lowCNIH4_mat,diag=F)]

p12<-ggcorrplot(highlow_mat[,dim(highlow_mat)[1]:1],
           p.mat = p.highlow_mat[,dim(highlow_mat)[1]:1], 
           lab = F,
           lab_size = 2,
           insig="blank",
           outline.color = 'black')+
  theme(legend.position="right")+
  labs(fill="Corr")+
  theme(axis.text.x = element_text(face="bold", colour="black", size=12),
        axis.text.y = element_text(face="bold", colour="black", size=12),
        legend.text = element_text(size = 15),
        legend.title = element_text( colour="black", size=12))+
  guides(fill = guide_colourbar(title = "Corr",
                                size=15,
                                barheight = 40)) + 
  scale_fill_gradientn(colors=natparks.pals("Acadia"),limit = c(-1,1)) + annotate('segment', 
               x = dim(highlow_mat)[1] + .5, 
               xend = 0.5, 
               y = 0.5, 
               yend = dim(highlow_mat)[1] + .5, 
               color = 'black', size = 0.25)

tmp <- highlow_mat
#tmp[is.na(raw_p)] <- NA
tmp[raw_p >= 0.05] <- NA
tmp<-which(!is.na(tmp[dim(highlow_mat)[1]:1,]), arr.ind=T)

for(row in 1:nrow(tmp)) {
  i = tmp[row,]
  p12 <- p12 + annotate('rect', 
               xmin = i[2]-0.5, 
               xmax = i[2]+0.5, 
               ymin = i[1]-0.5, 
               ymax = i[1]+0.5,
           fill = NA, color = 'black', size = 0.5)
}

ggcorrplot(scores[,dim(highlow_mat)[1]:1],
           p.mat = raw_p[,dim(highlow_mat)[1]:1], 
           colors = col,
           show.diag = TRUE,
           lab = F, 
           lab_size = 2,
           insig="blank",
           #ggtheme =ggplot2::theme_void,
           outline.color = 'black',
           )

p3 <- ggcorrplot(scores[,dim(highlow_mat)[1]:1],
           p.mat = raw_p[,dim(highlow_mat)[1]:1], 
           colors = col,
           show.diag = TRUE,
           lab = F, 
           lab_size = 2,
           insig="blank",
           #ggtheme =ggplot2::theme_void,
           outline.color = 'black',
           ) +
  theme(legend.position="right")+
  labs(fill="Differential Z-scores")+
  scale_fill_gradient2(limit = c(-6,6), 
                       low = col[1], 
                       high =  col[3], 
                       mid = col[2], midpoint = 0)+
  
  theme(axis.text.x = element_text(face="bold", colour="black", size=12,angle = 45),
        axis.text.y = element_text(face="bold", colour="black", size=12,hjust = 1),
        legend.text = element_text(size = 15),
        legend.title = element_text( colour="black", size=12,angle = -90,
                                     hjust = 0.5, vjust = 0.5),
        panel.border = element_rect(colour = "black", fill=NA, size=1,linewidth = 1)) +   
  guides(fill = guide_colourbar(title = "Differential Z-scores",
                                title.position = "right",size=15,
                                barheight = 40))
p3
############################################################################################
set.seed(7)
dcnet <- dcNetwork(scores,
                   raw_p,
                   thresh=0.05)

e <- get.edgelist(dcnet,names=FALSE)
l <- qgraph.layout.fruchtermanreingold(e,
                                       vcount=vcount(dcnet),
                                       area=15*(vcount(dcnet)^2),
                                       repulse.rad=(vcount(dcnet)^3.3)
                                       )
# Isolated = which(degree(dcnet)==0)
# dcnet = delete.vertices(dcnet, Isolated)
# l = l[-Isolated,]

png(file=paste0(path_output,"/Figure_dcnet_cytokine_PTB.png"),res=900, units = 'in', width=7, height = 7)
plot(dcnet,layout=l,
     vertex.size=2,
     vertex.label.cex = 0.5,
     vertex.label.dist=0.5,
     edge.width=1,
     main = 'Differential co-expression network',
     width=2,
     layout.rotate = 100,
     )

dev.off()

#########################################################################################
sigf_lowCNIH4_mat <- lowCNIH4_mat
sigf_lowCNIH4_mat[raw_p>=0.05] <- NA

sigf_highCNIH4_mat <- highCNIH4_mat
sigf_highCNIH4_mat[raw_p>=0.05] <- NA

low_corr <- sigf_lowCNIH4_mat[upper.tri(sigf_lowCNIH4_mat,diag=F)]
high_corr <- sigf_highCNIH4_mat[upper.tri(sigf_highCNIH4_mat,diag=F)]

low_high <- data.frame(low_corr,high_corr)
names(low_high) <- c('Low CNIH4','High CNIH4')

low_high_long <- pivot_longer(low_high,colnames(low_high))
names(low_high_long) <- c('CNIH4level','Coexpression')

p5<-ggplot(data=low_high_long,
       aes(x=fct_reorder(CNIH4level, Coexpression, .na_rm = TRUE,.desc =TRUE),
           y=Coexpression)) +
  theme_bw() +
  geom_violin(aes(color=CNIH4level,fill=CNIH4level),
              width=0.7,alpha=0.5,
              trim=FALSE)+
  scale_fill_manual(values=c("#B48EAD","#81A1C1"))+
  scale_color_manual(values=c("#B48EAD","#81A1C1"))+
  geom_boxplot(aes(color=CNIH4level),
               size=1,
               position=position_dodge(1),
               width=0.2,
               outlier.colour="red",
               outlier.shape=NA,outlier.size=3)+
    geom_jitter(aes(color=CNIH4level,fill=CNIH4level),
              width=0.05,
              height=0,
              size=2,
              alpha = 0.7)+
  labs(x="",y = "Absolute pairwise coexpression", title = "")+
  theme(plot.title = element_text(size = 25),
        legend.position = "none",
        legend.text = element_text(size = 20) ,
        legend.title  = element_text(size = 20,color="black",face="bold"),
        axis.text = element_text(size = 25),
        axis.text.x=element_text(color="black",size=13,face="bold"),
        axis.title.x = element_text(size = 20,color="black",face="bold"),
        axis.text.y=element_text(color="black",size=20),
        axis.title.y = element_text(size = 20,color="black",face="bold"),
        axis.title= element_text(size = 40,color="black",face="bold"))+
  stat_compare_means( size = 5,
                      label.x = 1.3,
                      label.y = 1.3)

p5
```

### DESEQ2

```{r}
library(EnhancedVolcano)
library(comprehenr)

df <- filter(vst_ptb_tbm,Type=='PTB') %>% select(c('LIMS_ID','CNIH4level'))
PTB_sample_RNAseq <- All_sample_RNAseq %>% subset(Study %in% c("28TB","29TB"))
count_data <-count_all[,rownames(PTB_sample_RNAseq)]
count_data<-count_data[ , !(names(count_data) %in% c('HOA7818A92'))] # drop 1 patients not in vst

df<- df[order(df$LIMS_ID),] #col
df$CNIH4level<-factor(df$CNIH4level,levels=c(1,2))
df$LIMS_ID<-NULL

count_data<-count_data[ , order(names(count_data))]
anno_symbol <- anno[,c("gene_id", "gene_symbol")] %>% filter(gene_id %in% rownames(count_data))
rownames(anno_symbol) <- anno_symbol$gene_id
anno_symbol <- anno_symbol[rownames(count_data),]
count_data <- cbind(genenames=anno_symbol$gene_symbol,count_data)
count_data <-count_data %>% filter(genenames %in% names(RNA_data) & genenames!='CNIH4')

count_data$genenames<-NULL
anno_symbol <- anno[,c("gene_id", "gene_symbol")] %>% filter(gene_id %in% rownames(count_data))

dup_genes_id <- anno_symbol[duplicated(anno_symbol$gene_symbol), ]$gene_id
count_data <- count_data[!(rownames(count_data) %in% dup_genes_id),]

dds <- DESeqDataSetFromMatrix(count_data, colData=df, ~CNIH4level)
dds <- DESeq(dds)

#results(dds, contrast=c("condition","C","B")) meaning genes with:
#logFC > 0 are overexpressed in C and underexpressed in B.
#logFC < 0 means underexpressed in C and overexpressed in B

res1 <- results(dds,contrast=c('CNIH4level',2,1),alpha=0.05)
#res2 <- lfcShrink(dds, coef= 'CNIH4level_2_vs_1', type="apeglm")
summary(res1)

labels <- mapvalues(rownames(res1), 
          from=anno_symbol$gene_id, 
          to=anno_symbol$gene_symbol)

EnhancedVolcano(res1,
    lab = labels,
    x = 'log2FoldChange',labSize = 2.0,
    pCutoff = 0.05,
    FCcutoff = log2(1.5),
    y = 'padj',)

get_DEGgenes <- function(df,reg){
    if(reg=='high'){
      key <- intersect(rownames(df)[which(df$log2FoldChange>=log2(1.5))], rownames(df)[which(df$padj<0.05)])
    }
    if(reg=='low'){
      key <- intersect(rownames(df)[which(df$log2FoldChange<=-log2(1.5))], rownames(df)[which(df$padj<0.05)])
    }
    results <- as.data.frame((df)[which(rownames(df) %in% key),])
    return(results)
}

deg_high <- rownames(get_DEGgenes(as.data.frame(res1),reg='high'))
deg_low <- rownames(get_DEGgenes(as.data.frame(res1),reg='low'))

deg_high <- to_vec(for(i in 1:length(deg_high)) filter(anno_symbol,gene_id==deg_high[i])$gene_symbol)
deg_low <- to_vec(for(i in 1:length(deg_low)) filter(anno_symbol,gene_id==deg_low[i])$gene_symbol)
```

### Pathway Analysis

```{r}
ORA_bar_plot <- function(df,name,n=5){
  n <- min(nrow(df),n)
  df <- df[1:n,]
  #n_break <- as.integer(max(df$log_pvalue))
  p <- ggplot(aes(x= ID,y = log_pvalue),data =df) + 
  geom_col(position = "stack", 
           alpha = 0.5,fill="#4292c6") +
  geom_text(aes(x=ID,y=0.1,label =ID), 
            size=3,fontface='bold',hjust=0)+
  ggtitle(name)+
  #geom_text(aes(x=ID,y=pos,label =log_pvalue), hjust=0.5) +
  #scale_y_continuous(breaks = 1:n_break)+ 
  coord_flip()+
  labs(x="", y="Log10 P value") +
  #scale_fill_manual(values=c("#4292c6")) +
  theme_bw()+
  theme(plot.title = element_text(size = 20),
        legend.text = element_text(size = 15) ,
        legend.position="right",
        legend.title = element_text(size = 13,color="black",face="bold"),
        axis.text.x=element_text(color="black",size=13),
        axis.title.x = element_text(size = 13,color="black",face="bold"),
        axis.text.y=element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_text(size = 13,color="black",face="bold"))
  
  #p
  return(p)
}
```

```{r}
library(msigdbr)
library(dplyr)
library(clusterProfiler)
# db <- msigdbr(species = "Homo sapiens", category = "H") %>%
#   dplyr::select(gs_name, human_gene_symbol)
#C5, C8

# db <- msigdbr(species = "Homo sapiens", category = "C5") %>%
#   filter(gs_subcat=="GO:BP") %>% #C5
#   dplyr::select(gs_name, human_gene_symbol)

db <- msigdbr(species = "Homo sapiens", category = "C8") %>%
  dplyr::select(gs_name, human_gene_symbol)

dim(db)

ORA_analysis <- function(gene_list){
  temp <- enricher(gene_list, TERM2GENE=db, pvalueCutoff = 1, qvalueCutoff = 1)
  temp <- temp@result
  if(!is.na(table(temp$p.adjust < padj)["TRUE"]) &  table(temp$p.adjust < padj)["TRUE"]>10){
    temp <- temp %>% filter(p.adjust<padj) %>%
    dplyr::arrange(pvalue)
    } 
  else{
    temp <- temp %>%
    dplyr::arrange(pvalue)
    temp <- temp[1:min(nrow(temp),10),]
    }
  # df <- temp %>%
  # dplyr::arrange(pvalue) %>%
  # dplyr::mutate(log_pvalue=-log10(pvalue),
  #               pos = ifelse(log_pvalue <4,log_pvalue + 1,log_pvalue + 0.5))
  # ORA_bar_plot(df)
  return(temp)
}

ora_low <- ORA_analysis(deg_low)
df1 <- ora_low %>%
  dplyr::arrange(pvalue) %>%
  dplyr::mutate(log_pvalue=-log10(pvalue),
                pos = ifelse(log_pvalue <4,log_pvalue + 1,log_pvalue + 0.5))
p1<-ORA_bar_plot(df1,'Genes down-regulated in high CNIH4')
p1
ora_high <- ORA_analysis(deg_high)
df2 <- ora_high %>%
  dplyr::arrange(pvalue) %>%
  dplyr::mutate(log_pvalue=-log10(pvalue),
                pos = ifelse(log_pvalue <4,log_pvalue + 1,log_pvalue + 0.5))
p2<-ORA_bar_plot(df1,'Genes up-regulated in high CNIH4')


n = 5
df1 <- df1[1:min(nrow(df1),n),] %>% mutate(group='downregulated genes') %>% arrange(ID)
df2 <- df2[1:min(nrow(df2),n),] %>% mutate(group='upregulated genes') %>% arrange(ID)
df <- rbind(df1,df2)
df$ID <- factor(df$ID, levels = df$ID)

#n_break <- as.integer(max(df$log_pvalue))
p <- ggplot(data =df,aes(x= ID,y = log_pvalue,fill=group)) + 
  geom_col(position = 'stack',
         alpha = 0.5,
         aes(x=ID,y = log_pvalue,
             fill = group)) +
scale_fill_manual( values = c('#5E81AC','#BF616A'))+
geom_text(aes(x=ID,y=0.1,label =ID), 
          size=3,fontface='bold',hjust=0)+
#geom_text(aes(x=ID,y=pos,label =log_pvalue), hjust=0.5) +
#scale_y_continuous(breaks = 1:n_break)+ 
coord_flip()+
labs(x="", y="Log10 P value") +
#scale_fill_manual(values=c("#4292c6")) +
theme_bw()+
theme(plot.title = element_text(size = 20),
      legend.text = element_text(size = 15) ,
      legend.position="right",
      legend.title = element_text(size = 13,color="black",face="bold"),
      axis.text.x=element_text(color="black",size=13),
      axis.title.x = element_text(size = 13,color="black",face="bold"),
      axis.text.y=element_blank(),
      axis.ticks.y = element_blank(),
      axis.title.y = element_text(size = 13,color="black",face="bold"))
p
```

```{r}
for(i in 1:2){
  print(i)
}
```
